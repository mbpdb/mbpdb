{% extends 'peptide/base.html' %}
{% load static %}
{% block 'content' %}
<h1> MBPDB add peptides (multiple entries)</h1>

<button id="start-task-btn">Start Task</button>
<div id="task-progress"></div>
<div id="elapsed-time"></div>
<div id="time-remaining"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#start-task-btn').click(function() {
            $.ajax({
                url: '{% url "start_work" %}',
                method: 'GET',
                success: function(data) {
                    let taskId = data.task_id;
                    console.log('Task started with ID:', taskId);
                    $('#task-progress').html('<p>Task started</p>');
                    pollProgress(taskId);
                },
                error: function(err) {
                    console.error('Error starting task:', err);
                }
            });
        });

        function pollProgress(taskId) {
            console.log('Polling progress for task ID:', taskId);
            $.ajax({
                url: `/check-progress/${taskId}/`,
                method: 'GET',
                success: function(data) {
                    console.log('Progress data:', data);
                    $('#task-progress').html('Progress: ' + data.progress + '%');
                    $('#elapsed-time').html('Elapsed time: ' + data.elapsed_time.toFixed(2) + ' minutes');
                    $('#time-remaining').html('Estimated time remaining: ' + data.time_remaining.toFixed(2) + ' minutes');
                    if (data.progress < 100) {
                        setTimeout(function() {
                            pollProgress(taskId);
                        }, 1000);
                    } else {
                        $('#task-progress').html('Task complete');
                        $('#elapsed-time').html('Elapsed time: ' + data.elapsed_time.toFixed(2) + ' minutes');
                        $('#time-remaining').html('Estimated time remaining: 0.00 minutes');
                    }
                },
                error: function(err) {
                    console.error('Error polling progress:', err);
                }
            });
        }
    });
</script>
<h4>Add to Milk Bioactive Peptide database using TSV (tab-separated values) file</h4>
{% for e in errors %}
<div class="alert alert-danger  alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert">
  <span aria-hidden="true">&times;</span>
  <span class="sr-only">Close</span>
  </button>
  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
  <span class="sr-only">Error:</span>
  {{e}}
</div>
{% endfor %}
{% for m in messages %}
<div class="alert alert-info  alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert">
    <span aria-hidden="true">&times;</span>
    <span class="sr-only">Close</span>
  </button>
  <span class="sr-only">Error:</span>
  {{m}}
</div>
{% endfor %}

<form method="POST" enctype="multipart/form-data" action="." role="form">
{% csrf_token %}
<div class="form-group">
     <input type="file" name="csv_file" />
     <p class="help-block">Use a correctly formatted TSV file with UTF-8 encoding. For format requirements, view the <a href="{% static 'peptide/example/peptide_db_input_file_example.tsv'%}">example file</a>.</p>
     <p class="help-block">Note that the additionals details, ic50,  inhibition type, inhibited microrganisms, and abstract columns can be empty.</p>
</div>

<button class="btn btn-default">Add to DB</button>
</form>
</br>
<a  href="#" id="toggleProteinList">Toggle list of cataloged protein IDs & descriptions</a>
<div id="proteinList" style="display:none;"></div>
<br/><br/><br/><br/>
<script>
let proteinDataFetched = false;  // This variable will track if we've already fetched the data

document.getElementById("toggleProteinList").addEventListener("click", function(event) {
    event.preventDefault(); // Prevents the default action of the hyperlink

    const proteinListDiv = document.getElementById("proteinList");

    // If we haven't fetched the protein data yet, fetch it now
    if (!proteinDataFetched) {
        fetch("/get_protein_list/")
        .then(response => response.json())
        .then(data => {
            let content = "";
            for (let desc of Object.keys(data)) {
                for (let pid of data[desc]) {
                    content += `<p>${desc} (${pid})</p>`;
                }
            }
            proteinListDiv.innerHTML = content;
            proteinDataFetched = true; // Mark data as fetched
        })
        .catch(error => {
            console.error("There was an error fetching the protein data:", error);
        });
    }

    // Toggle display based on current state
    if (proteinListDiv.style.display === "none" || !proteinListDiv.style.display) {
        proteinListDiv.style.display = "block";
    } else {
        proteinListDiv.style.display = "none";
    }
});
</script>
{% endblock 'content' %}
