name: Sync Notebooks to Personal Repo

on:
  push:
    branches: [ main ]
    paths: 
      - 'include/peptide/peptide/notebooks/**'

jobs:
  sync-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout organization repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for subtree
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config --global user.name "kuhfeldrf"
        git config --global user.email "kuhfeldrf@gmail.com"
    
    - name: Debug token availability
      run: |
        if [ -z "${{ secrets.PERSONAL_GITHUB_TOKEN }}" ]; then
          echo "‚ùå PERSONAL_GITHUB_TOKEN is not set or empty"
          exit 1
        else
          echo "‚úÖ PERSONAL_GITHUB_TOKEN is available"
        fi
    
    - name: Verify notebooks directory exists
      run: |
        if [ ! -d "include/peptide/peptide/notebooks" ]; then
          echo "Error: Notebooks directory not found"
          exit 1
        fi
        echo "Found notebooks directory with $(find include/peptide/peptide/notebooks -name "*.ipynb" | wc -l) notebook files"
    
    - name: Sync notebooks with commit info
      run: |
        # Get commit info from the current push
        COMMIT_MSG=$(git log --format=%s -n 1 ${{ github.sha }})
        COMMIT_AUTHOR=$(git log --format="%an <%ae>" -n 1 ${{ github.sha }})
        COMMIT_DATE=$(git log --format=%ad -n 1 ${{ github.sha }})
        
        # Clone the target repository
        git clone https://${{ secrets.PERSONAL_GITHUB_TOKEN }}@github.com/Kuhfeldrf/peptiline.git temp_repo
        cd temp_repo
        
        # Remove all existing files except .git directory
        find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
        
        # Copy current notebook files
        cp -r ../include/peptide/peptide/notebooks/* . 2>/dev/null || echo "No files to copy"
        
        # Stage all changes
        git add .
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Commit with original author info and enhanced message
          git commit --author="$COMMIT_AUTHOR" --date="$COMMIT_DATE" -m "$COMMIT_MSG

Synced from MBPDB notebooks directory
Original commit: ${{ github.sha }}
Repository: ${{ github.repository }}"
          
          echo "Pushing notebooks to main branch"
          git push origin main
          echo "‚úÖ Successfully synced with commit info preserved"
        fi
        
        # Return to original directory and cleanup
        cd ..
        rm -rf temp_repo
    
    - name: Verify sync success
      run: |
        echo "‚úÖ Successfully synced notebooks with commit info preserved"
        echo "üìÇ Repository URL: https://github.com/Kuhfeldrf/peptiline"
        echo "üìù Note: Commit author, date, and message preserved from original MBPDB commit"
        echo "üîÑ Changes are now live on the main branch"
