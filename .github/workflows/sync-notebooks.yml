name: Sync Notebooks to Personal Repo

on:
  push:
    branches: [ main ]
    paths: 
      - 'include/peptide/peptide/notebooks/**'

jobs:
  sync-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout organization repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for subtree
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config --global user.name "kuhfeldrf"
        git config --global user.email "kuhfeldrf@gmail.com"
    
    - name: Checkout peptiline repo
      uses: actions/checkout@v4
      with:
        repository: Kuhfeldrf/peptiline
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: peptiline-repo
        fetch-depth: 0
    
    - name: Create sync branch
      run: |
        cd peptiline-repo
        git checkout -b sync-notebooks-$(date +%Y%m%d-%H%M%S) || git checkout sync-notebooks-$(date +%Y%m%d-%H%M%S)
    
    - name: Copy notebook changes
      run: |
        # Remove existing notebooks in target repo (if any)
        rm -rf peptiline-repo/notebooks || true
        
        # Copy notebooks from source to target
        mkdir -p peptiline-repo/notebooks
        cp -r include/peptide/peptide/notebooks/* peptiline-repo/notebooks/
        
        echo "Copied $(find peptiline-repo/notebooks -name "*.ipynb" | wc -l) notebook files"
    
    - name: Commit and push changes
      run: |
        cd peptiline-repo
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "Sync notebooks from MBPDB - $(date)"
        git push origin HEAD
        
        echo "âœ… Successfully pushed notebook changes to branch: $(git branch --show-current)"
        echo "Branch URL: https://github.com/Kuhfeldrf/peptiline/tree/$(git branch --show-current)"
