name: Sync Notebooks to Personal Repo

on:
  push:
    branches: [ main ]
    paths: 
      - 'include/peptide/peptide/notebooks/**'

jobs:
  sync-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout organization repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for subtree
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config --global user.name "kuhfeldrf"
        git config --global user.email "kuhfeldrf@gmail.com"
    
    - name: Debug token availability
      run: |
        if [ -z "${{ secrets.PERSONAL_GITHUB_TOKEN }}" ]; then
          echo "âŒ PERSONAL_GITHUB_TOKEN is not set or empty"
          exit 1
        else
          echo "âœ… PERSONAL_GITHUB_TOKEN is available"
        fi
    
    - name: Verify notebooks directory exists
      run: |
        if [ ! -d "include/peptide/peptide/notebooks" ]; then
          echo "Error: Notebooks directory not found"
          exit 1
        fi
        echo "Found notebooks directory with $(find include/peptide/peptide/notebooks -name "*.ipynb" | wc -l) notebook files"
    
    - name: Setup authenticated remote and push notebooks
      run: |
        # Remove any existing peptiline remote
        git remote remove peptiline 2>/dev/null || true
        
        # Add remote with explicit token authentication
        git remote add peptiline https://${{ secrets.PERSONAL_GITHUB_TOKEN }}@github.com/Kuhfeldrf/peptiline.git
        
        # Verify remote is added correctly
        git remote -v
        
        # Create branch name with timestamp
        BRANCH_NAME="sync-notebooks-$(date +%Y%m%d-%H%M%S)"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        echo "Creating branch: $BRANCH_NAME"
        
        # Push notebooks using subtree to new branch
        echo "Pushing notebooks to new branch: $BRANCH_NAME"
        git subtree push --prefix=include/peptide/peptide/notebooks peptiline $BRANCH_NAME
    
    - name: Verify sync success
      run: |
        echo "âœ… Successfully synced notebooks to new branch: $BRANCH_NAME"
        echo "ðŸ“‚ Branch URL: https://github.com/Kuhfeldrf/peptiline/tree/$BRANCH_NAME"
        echo "ðŸ”„ Create a pull request to merge the changes: https://github.com/Kuhfeldrf/peptiline/compare/$BRANCH_NAME"
