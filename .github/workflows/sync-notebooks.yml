name: Sync Notebooks to Personal Repo

on:
  push:
    branches: [ main ]
    paths: 
      - 'include/peptide/peptide/notebooks/**'

jobs:
  sync-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout organization repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for subtree
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config --global user.name "kuhfeldrf"
        git config --global user.email "kuhfeldrf@gmail.com"
    
    - name: Debug token availability
      run: |
        if [ -z "${{ secrets.PERSONAL_GITHUB_TOKEN }}" ]; then
          echo "âŒ PERSONAL_GITHUB_TOKEN is not set or empty"
          exit 1
        else
          echo "âœ… PERSONAL_GITHUB_TOKEN is available"
        fi
    
    - name: Verify notebooks directory exists
      run: |
        if [ ! -d "include/peptide/peptide/notebooks" ]; then
          echo "Error: Notebooks directory not found"
          exit 1
        fi
        echo "Found notebooks directory with $(find include/peptide/peptide/notebooks -name "*.ipynb" | wc -l) notebook files"
    
    - name: Sync notebook contents (no history)
      run: |
        # Clone the target repository (shallow clone for efficiency)
        git clone --depth 1 https://${{ secrets.PERSONAL_GITHUB_TOKEN }}@github.com/Kuhfeldrf/peptiline.git temp_repo
        cd temp_repo
        
        # Remove all existing files except .git directory
        find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
        
        # Copy notebook files to root of target repo (contents only, not the folder)
        cp -r ../include/peptide/peptide/notebooks/* . 2>/dev/null || echo "No files to copy"
        
        # Add and commit changes (this creates a new commit without preserving source history)
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Sync notebook contents from MBPDB - $(date '+%Y-%m-%d %H:%M:%S')"
          echo "Pushing notebook contents to main branch"
          git push origin main
        fi
        
        # Return to original directory and cleanup
        cd ..
        rm -rf temp_repo
    
    - name: Verify sync success
      run: |
        echo "âœ… Successfully synced notebooks with commit history preserved"
        echo "ğŸ“‚ Repository URL: https://github.com/Kuhfeldrf/peptiline"
        echo "ğŸ“ Note: Full commit history from the notebooks directory is preserved"
        echo "ğŸ”„ Changes are now live on the main branch"
